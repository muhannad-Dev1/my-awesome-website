<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUFEED IT - Cloud System</title>
    <style>
        :root { --brand-purple: #744394; --brand-grey: #525252; --bg-light: #f3f4f6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg-light); color: var(--brand-grey); }
        .logo-container { text-align: center; margin-bottom: 2rem; }
        .login-logo-img { width: 200px; height: auto; display: block; margin: 0 auto; }
        .login-page { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; }
        .login-card { background: white; padding: 3rem; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); width: 100%; max-width: 450px; border-top: 5px solid var(--brand-purple); }
        .input-group { margin-bottom: 1.5rem; text-align: right; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--brand-purple); }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 0.85rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
        .btn { padding: 0.85rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-login { width: 100%; background: var(--brand-purple); color: white; }
        .btn-primary { background: var(--brand-purple); color: white; }
        .btn-danger { background: #ef4444; color: white; padding: 5px 10px; }
        .btn-success { background: #10b981; color: white; }
        .message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; text-align: center; }
        .message.error { background: #fee2e2; color: #991b1b; }
        .app-container { display: none; min-height: 100vh; }
        .app-header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-bottom: 3px solid var(--brand-purple); }
        .header-logo-img { height: 50px; width: auto; }
        .content { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .nav-bar { display: flex; gap: 0.5rem; background: white; padding: 0.5rem; border-radius: 12px; margin-bottom: 2rem; }
        .nav-btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; background: transparent; font-weight: bold; }
        .nav-btn.active { background: var(--brand-purple); color: white; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .card { background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 2rem; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .data-table th, .data-table td { padding: 1rem; text-align: right; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="loginPage" class="login-page">
        <div class="logo-container">
            <img src="logo.png" alt="MUFEED Logo" class="login-logo-img">
        </div>
        <div class="login-card">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</h2>
            <div id="loginMsg" class="message"></div>
            <form id="loginFormElement">
                <div class="input-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="usernameInput" required>
                </div>
                <div class="input-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="passwordInput" required>
                </div>
                <button type="submit" class="btn btn-login">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>

    <div id="mainApplication" class="app-container">
        <div class="app-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="logo.png" alt="Logo" class="header-logo-img">
                <h3 style="color: var(--brand-purple);">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</h3>
            </div>
            <div>
                <span id="displayUsername" style="font-weight: bold;"></span>
                <button onclick="logout()" class="btn btn-danger" style="margin-right:10px">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div class="content">
            <div class="nav-bar">
                <button class="nav-btn active" onclick="nav('search', this)">ğŸ” Ø§Ù„Ø¨Ø­Ø«</button>
                <button class="nav-btn" onclick="nav('add', this)">â• Ø¥Ø¶Ø§ÙØ©</button>
                <button class="nav-btn" onclick="nav('browse', this)">ğŸ“‚ ØªØµÙØ­ Ø§Ù„ÙƒÙ„</button>
                <button class="nav-btn" id="adminBtn" onclick="nav('admin', this)" style="display:none;">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
            </div>

            <div id="searchSection" class="page-section active">
                <div class="card">
                    <input type="text" id="aiInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø­Ù„..." style="width:100%; padding:1rem; border-radius:8px; border:1px solid #ddd">
                    <button class="btn btn-primary" onclick="searchAI()" style="width:100%; margin-top:10px">Ø¨Ø­Ø«</button>
                    <div id="searchResults" style="margin-top:20px"></div>
                </div>
            </div>

            <div id="addSection" class="page-section">
                <div class="card">
                    <form id="addIssueForm">
                        <div class="input-group"><label>Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label><input type="text" id="newDesc" required></div>
                        <div class="input-group"><label>Ø§Ù„ØªØµÙ†ÙŠÙ</label><select id="newCat"><option>Network</option><option>Hardware</option><option>Software</option></select></div>
                        <div class="input-group"><label>Ø§Ù„Ø­Ù„</label><textarea id="newSol" rows="4" required></textarea></div>
                        <button type="submit" class="btn btn-success">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨</button>
                    </form>
                </div>
            </div>

            <div id="browseSection" class="page-section">
                <div class="card">
                    <button onclick="exportToExcel()" class="btn btn-success">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
                    <div id="browseList" style="margin-top:20px"></div>
                </div>
            </div>

            <div id="adminSection" class="page-section">
                <div class="card">
                    <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                    <table class="data-table"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="adminUsersTable"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyDUZhF1eD_LRdbK9lBzqQ9Kpt56ELeAZDo",
            authDomain: "mufeed-it-968b3.firebaseapp.com",
            databaseURL: "https://mufeed-it-968b3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mufeed-it-968b3",
            storageBucket: "mufeed-it-968b3.firebasestorage.app",
            messagingSenderId: "229628615586",
            appId: "1:229628615586:web:d0331cc7509e69ae0c70fb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let usersDB = [];
        let issuesDB = [];
        let currentUser = JSON.parse(localStorage.getItem('activeUser'));

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        onValue(ref(db, 'users'), (snapshot) => {
            const data = snapshot.val();
            usersDB = data ? Object.values(data) : [{ user: 'admin', pass: 'admin123', role: 'admin' }];
            if (currentUser) enterSystem();
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
        onValue(ref(db, 'issues'), (snapshot) => {
            const data = snapshot.val();
            issuesDB = data ? Object.entries(data).map(([id, val]) => ({ id, ...val })) : [];
            renderBrowse();
        });

        // Ø¯Ø®ÙˆÙ„
        document.getElementById('loginFormElement').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('usernameInput').value;
            const p = document.getElementById('passwordInput').value;
            const user = usersDB.find(x => x.user === u && x.pass === p);
            if(user) {
                currentUser = user;
                localStorage.setItem('activeUser', JSON.stringify(user));
                enterSystem();
            } else {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        };

        window.enterSystem = function() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApplication').style.display = 'block';
            document.getElementById('displayUsername').textContent = currentUser.user;
            if(currentUser.role === 'admin') document.getElementById('adminBtn').style.display = 'block';
        };

        window.logout = function() {
            localStorage.removeItem('activeUser');
            location.reload();
        };

        window.nav = function(id, btn) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id+'Section').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(id === 'admin') renderAdmin();
        };

        document.getElementById('addIssueForm').onsubmit = (e) => {
            e.preventDefault();
            const newIssue = {
                desc: document.getElementById('newDesc').value,
                cat: document.getElementById('newCat').value,
                sol: document.getElementById('newSol').value,
                by: currentUser.user
            };
            push(ref(db, 'issues'), newIssue);
            alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹');
            e.target.reset();
        };

        function renderBrowse() {
            document.getElementById('browseList').innerHTML = issuesDB.map(i => `
                <div style="padding:15px; border-bottom:1px solid #eee">
                    <b>${i.cat}</b>: ${i.desc} <br> <small>Ø§Ù„Ø­Ù„: ${i.sol}</small>
                </div>
            `).join('');
        }

        function renderAdmin() {
            document.getElementById('adminUsersTable').innerHTML = usersDB.map(u => `
                <tr><td>${u.user}</td><td>${u.role}</td><td>---</td></tr>
            `).join('');
        }

        window.searchAI = function() {
            const q = document.getElementById('aiInput').value.toLowerCase();
            const res = issuesDB.filter(i => i.desc.toLowerCase().includes(q));
            document.getElementById('searchResults').innerHTML = res.map(i => `<div class="card"><b>${i.desc}</b><p>${i.sol}</p></div>`).join('');
        };
        
        window.exportToExcel = function() {
            let csv = "\uFEFFØ§Ù„Ù…Ø´ÙƒÙ„Ø©,Ø§Ù„Ø­Ù„\n" + issuesDB.map(i => `${i.desc},${i.sol}`).join('\n');
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Mufeed_Cloud_Data.csv";
            link.click();
        };
    </script>
</body>
</html>
